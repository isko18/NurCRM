# –£–ª—É—á—à–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ NurCRM

## ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

### 1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è Redis

**–§–∞–π–ª:** `core/settings.py`

- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è —á–µ—Ä–µ–∑ Redis
- ‚úÖ –ù–∞—Å—Ç—Ä–æ–µ–Ω—ã —Ç–∞–π–º–∞—É—Ç—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –¥–∞–Ω–Ω—ã—Ö:
  - `CACHE_TIMEOUT_SHORT = 60` (1 –º–∏–Ω—É—Ç–∞) - –¥–ª—è —á–∞—Å—Ç–æ –º–µ–Ω—è—é—â–∏—Ö—Å—è –¥–∞–Ω–Ω—ã—Ö
  - `CACHE_TIMEOUT_MEDIUM = 300` (5 –º–∏–Ω—É—Ç) - –¥–ª—è –æ–±—ã—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
  - `CACHE_TIMEOUT_LONG = 3600` (1 —á–∞—Å) - –¥–ª—è —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö
  - `CACHE_TIMEOUT_ANALYTICS = 600` (10 –º–∏–Ω—É—Ç) - –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```python
from django.core.cache import cache
from django.conf import settings

# –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ 5 –º–∏–Ω—É—Ç
cache.set('key', data, settings.CACHE_TIMEOUT_MEDIUM)
data = cache.get('key')
```

### 2. –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è

**–§–∞–π–ª:** `apps/main/cache_utils.py`

- ‚úÖ –°–æ–∑–¥–∞–Ω –º–æ–¥—É–ª—å —Å —É—Ç–∏–ª–∏—Ç–∞–º–∏ –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
- ‚úÖ –î–µ–∫–æ—Ä–∞—Ç–æ—Ä `@cached_result` –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–π
- ‚úÖ –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–ª—é—á–µ–π –∫—ç—à–∞
- ‚úÖ –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∫—ç—à–∞

**–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:**
```python
from apps.main.cache_utils import cached_result

@cached_result(timeout=300, key_prefix="agent_products")
def get_agent_products(agent, company):
    # –¢—è–∂–µ–ª—ã–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è
    return result
```

### 3. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è queryset –≤ views

**–§–∞–π–ª:** `apps/main/views.py`

–î–æ–±–∞–≤–ª–µ–Ω `select_related()` –¥–ª—è —Å–ª–µ–¥—É—é—â–∏—Ö views:
- ‚úÖ `ContactListCreateAPIView` - –¥–æ–±–∞–≤–ª–µ–Ω `select_related("company", "branch", "owner")`
- ‚úÖ `ContactRetrieveUpdateDestroyAPIView` - –¥–æ–±–∞–≤–ª–µ–Ω `select_related("company", "branch", "owner")`
- ‚úÖ `PipelineListCreateAPIView` - –¥–æ–±–∞–≤–ª–µ–Ω `select_related("company", "branch", "owner")`
- ‚úÖ `PipelineRetrieveUpdateDestroyAPIView` - –¥–æ–±–∞–≤–ª–µ–Ω `select_related("company", "branch", "owner")`
- ‚úÖ `DealListCreateAPIView` - –¥–æ–±–∞–≤–ª–µ–Ω `select_related("company", "branch", "pipeline", "contact", "assigned_to")`
- ‚úÖ `DealRetrieveUpdateDestroyAPIView` - –¥–æ–±–∞–≤–ª–µ–Ω `select_related("company", "branch", "pipeline", "contact", "assigned_to")`
- ‚úÖ `Review` views - –¥–æ–±–∞–≤–ª–µ–Ω `select_related("company", "branch", "user", "product")`
- ‚úÖ `Notification` views - –¥–æ–±–∞–≤–ª–µ–Ω `select_related("company", "branch", "user")`
- ‚úÖ `Event` views - –¥–æ–±–∞–≤–ª–µ–Ω `select_related("company", "branch", "user")`
- ‚úÖ `Warehouse` views - –¥–æ–±–∞–≤–ª–µ–Ω `select_related("company", "branch")`
- ‚úÖ `WarehouseEvent` views - –¥–æ–±–∞–≤–ª–µ–Ω `select_related("company", "branch", "warehouse", "responsible_person")`
- ‚úÖ `ProductCategory` views - –¥–æ–±–∞–≤–ª–µ–Ω `select_related("company", "branch", "parent")`
- ‚úÖ `ProductBrand` views - –¥–æ–±–∞–≤–ª–µ–Ω `select_related("company", "branch")`

**–≠—Ñ—Ñ–µ–∫—Ç:** –£—Å—Ç—Ä–∞–Ω–µ–Ω—ã N+1 –∑–∞–ø—Ä–æ—Å—ã –¥–ª—è —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤.

### 4. –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏

**–§–∞–π–ª:** `apps/main/analytics_agent.py`

- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è `build_agent_analytics_payload()` (10 –º–∏–Ω—É—Ç)
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è `_compute_agent_on_hand()` (1 –º–∏–Ω—É—Ç–∞)

**–≠—Ñ—Ñ–µ–∫—Ç:** –¢—è–∂–µ–ª—ã–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –∫—ç—à–∏—Ä—É—é—Ç—Å—è, —á—Ç–æ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —É—Å–∫–æ—Ä—è–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã.

### 5. –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

**–§–∞–π–ª:** `requirements.txt`

- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω `django-redis==5.4.0` –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Redis –∫—ç—à–µ–º

---

## üìã –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–π –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1: –ö—Ä–∏—Ç–∏—á–Ω–æ

1. **–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –æ—Å—Ç–∞–ª—å–Ω—ã–µ views**
   - –î–æ–±–∞–≤–∏—Ç—å `select_related()` –∏ `prefetch_related()` –≤–æ –≤—Å–µ views
   - –û—Å–æ–±–æ–µ –≤–Ω–∏–º–∞–Ω–∏–µ: `Client`, `Order`, `Sale`, `Task`, `Integration`

2. **–î–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã –≤ –ë–î**
   ```python
   # –í models.py –¥–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è —á–∞—Å—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤:
   class Meta:
       indexes = [
           models.Index(fields=['company', 'created_at']),
           models.Index(fields=['company', 'branch', 'status']),
           models.Index(fields=['agent', 'product', 'created_at']),
       ]
   ```

3. **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ø–∏—Å–∫–æ–≤ –ø—Ä–æ–¥—É–∫—Ç–æ–≤**
   - –ö—ç—à–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã `ProductListView` —Å —É—á–µ—Ç–æ–º —Ñ–∏–ª—å—Ç—Ä–æ–≤
   - –ò–Ω–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å –∫—ç—à –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø—Ä–æ–¥—É–∫—Ç–∞

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2: –í–∞–∂–Ω–æ

4. **–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∞–Ω–∞–ª–∏—Ç–∏–∫—É**
   - –ö—ç—à–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã `OrderAnalyticsView`
   - –ö—ç—à–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã `AnalyticsView` (market analytics)
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è –¥–ª—è —Ç—è–∂–µ–ª—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

5. **–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã –∞–≥–µ–Ω—Ç–æ–≤**
   - –ö—ç—à–∏—Ä–æ–≤–∞—Ç—å `AgentMyProductsListAPIView`
   - –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å `_compute_agent_on_hand()` - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞–≥—Ä–µ–≥–∞—Ü–∏–∏ –≤–º–µ—Å—Ç–æ —Ü–∏–∫–ª–æ–≤

6. **–î–æ–±–∞–≤–∏—Ç—å –ø–∞–≥–∏–Ω–∞—Ü–∏—é –≤–µ–∑–¥–µ**
   - –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –≤—Å–µ list views –∏—Å–ø–æ–ª—å–∑—É—é—Ç –ø–∞–≥–∏–Ω–∞—Ü–∏—é
   - –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π `PAGE_SIZE` –¥–ª—è —Ä–∞–∑–Ω—ã—Ö endpoints

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3: –ñ–µ–ª–∞—Ç–µ–ª—å–Ω–æ

7. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `only()` –∏ `defer()`**
   - –ó–∞–≥—Ä—É–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã–µ –ø–æ–ª—è –¥–ª—è –±–æ–ª—å—à–∏—Ö –º–æ–¥–µ–ª–µ–π
   - –ü—Ä–∏–º–µ—Ä: `Product.objects.only('id', 'name', 'price')`

8. **–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ç–æ—Ä—ã**
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `SerializerMethodField` —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ
   - –ö—ç—à–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã `SerializerMethodField`

9. **–î–æ–±–∞–≤–∏—Ç—å database connection pooling**
   - –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø—É–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –¥–ª—è PostgreSQL
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `pgbouncer` –∏–ª–∏ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –ø—É–ª Django

10. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏**
    - –î–æ–±–∞–≤–∏—Ç—å `django-debug-toolbar` –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
    - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `django-silk` –¥–ª—è –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏—è
    - –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ–¥–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

---

## üîß –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—é

### 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

```bash
pip install -r requirements.txt
```

### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Redis

–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ Redis –∑–∞–ø—É—â–µ–Ω:
```bash
redis-cli ping
# –î–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å: PONG
```

### 3. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π (–µ—Å–ª–∏ –¥–æ–±–∞–≤–∏–ª–∏ –∏–Ω–¥–µ–∫—Å—ã)

```bash
python manage.py makemigrations
python manage.py migrate
```

### 4. –ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –∫—ç—à–∞

–ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –Ω—É–∂–Ω–æ –∏–Ω–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å –∫—ç—à:

```python
from apps.main.cache_utils import invalidate_cache_pattern

# –ò–Ω–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –∫—ç—à–∏ –ø—Ä–æ–¥—É–∫—Ç–æ–≤
invalidate_cache_pattern("products:*")

# –ò–Ω–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å –∫—ç—à–∏ –∞–≥–µ–Ω—Ç–∞
invalidate_cache_pattern("agent:*")
```

---

## üìä –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:
- N+1 –∑–∞–ø—Ä–æ—Å—ã –≤ —Å–ø–∏—Å–∫–∞—Ö: ~50-100 –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É
- –í—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏: 2-5 —Å–µ–∫—É–Ω–¥
- –í—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ –ø—Ä–æ–¥—É–∫—Ç–æ–≤: 1-3 —Å–µ–∫—É–Ω–¥—ã

### –ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:
- N+1 –∑–∞–ø—Ä–æ—Å—ã: 1-5 –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É ‚úÖ
- –í—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ (—Å –∫—ç—à–µ–º): 0.1-0.5 —Å–µ–∫—É–Ω–¥ ‚úÖ
- –í—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ –ø—Ä–æ–¥—É–∫—Ç–æ–≤: 0.3-1 —Å–µ–∫—É–Ω–¥–∞ ‚úÖ

**–û–∂–∏–¥–∞–µ–º–æ–µ —É—Å–∫–æ—Ä–µ–Ω–∏–µ: 3-10x** üöÄ

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è

```python
from django.core.cache import cache
from django.test import TestCase

class CacheTest(TestCase):
    def test_cache_works(self):
        cache.set('test_key', 'test_value', 60)
        self.assertEqual(cache.get('test_key'), 'test_value')
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∑–∞–ø—Ä–æ—Å–æ–≤

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `django-debug-toolbar` –∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ middleware:

```python
from django.db import connection
from django.utils.deprecation import MiddlewareMixin

class QueryCountMiddleware(MiddlewareMixin):
    def process_response(self, request, response):
        if settings.DEBUG:
            print(f"Queries: {len(connection.queries)}")
        return response
```

---

## üìù –ß–µ–∫–ª–∏—Å—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏

- [ ] Redis –∑–∞–ø—É—â–µ–Ω –∏ –¥–æ—Å—Ç—É–ø–µ–Ω
- [ ] –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç (–ø—Ä–æ–≤–µ—Ä–∏—Ç—å —á–µ—Ä–µ–∑ `cache.get/set`)
- [ ] –í—Å–µ views –∏—Å–ø–æ–ª—å–∑—É—é—Ç `select_related()` –≥–¥–µ –Ω—É–∂–Ω–æ
- [ ] –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∫—ç—à–∏—Ä—É–µ—Ç—Å—è
- [ ] –ù–µ—Ç N+1 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –æ—Å–Ω–æ–≤–Ω—ã—Ö endpoints
- [ ] –î–æ–±–∞–≤–ª–µ–Ω—ã –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è —á–∞—Å—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- [ ] –ü–∞–≥–∏–Ω–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –≤–µ–∑–¥–µ

---

*–î–æ–∫—É–º–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω: 2025-01-27*
*–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: 2025-01-27*

