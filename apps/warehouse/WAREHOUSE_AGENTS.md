# Система агентов склада (Warehouse Agents)

Подробная документация по модулю «агенты склада»: самостоятельная регистрация агентов, заявки в компании, приём/отклонение/отстранение, доступ к операциям и заявкам на товар.

---

## 1. Обзор

### 1.1 Назначение

- **Агент** — пользователь, который может работать со складами компании **без** того, чтобы быть сотрудником (employee) этой компании.
- Агент **сам** находит компании в системе, отправляет заявку на то, чтобы стать агентом склада компании.
- **Владелец или администратор** компании принимает или отклоняет заявку.
- После **принятия** агент получает доступ ко всем операциям по складам этой компании (заявки на товар, документы продажи/возврата и т.д.).
- Владелец в любой момент может **отстранить** агента — доступ к складам компании снимается.

### 1.2 Роли

| Роль | Описание | Доступ к складу |
|------|----------|------------------|
| **Владелец (owner)** | `user.owned_company` или роль `owner` | Полный доступ к своей компании |
| **Администратор (admin)** | Роль `admin` в компании | Полный доступ к компании |
| **Сотрудник (employee)** | `user.company` — привязан к компании | Доступ к складам своей компании |
| **Агент склада** | Принятая заявка `CompanyWarehouseAgent` со статусом `active` | Доступ к складам тех компаний, где он принят как агент |

Один пользователь может быть:
- сотрудником одной компании и при этом агентом в других;
- «свободным» агентом (без `user.company`), но принятым в несколько компаний через заявки.

---

## 2. Модель данных

### 2.1 CompanyWarehouseAgent

Связь «пользователь хочет быть / является агентом склада компании».

**Таблица:** `warehouse_companywarehouseagent`

| Поле | Тип | Описание |
|------|-----|----------|
| `id` | UUID | Первичный ключ |
| `company` | FK → users.Company | Компания |
| `user` | FK → User | Пользователь (агент) |
| `status` | str | Статус заявки/членства (см. ниже) |
| `note` | str (512) | Сообщение от агента при запросе (необязательно) |
| `created_at` | datetime | Дата создания заявки |
| `updated_at` | datetime | Дата обновления записи |
| `decided_at` | datetime, null | Когда владелец принял/отклонил/отстранил |
| `decided_by` | FK → User, null | Кто принял решение (владелец/админ) |

**Ограничение уникальности:** одна запись на пару `(company, user)`.

### 2.2 Статусы (CompanyWarehouseAgent.Status)

| Значение | Название | Описание |
|----------|----------|----------|
| `pending` | Ожидает решения | Агент отправил заявку, владелец ещё не ответил |
| `active` | Активен | Владелец принял заявку; агент имеет доступ к складам компании |
| `rejected` | Отклонён | Владелец отклонил заявку; повторная заявка в ту же компанию недоступна |
| `removed` | Отстранён | Агент был принят, но потом владелец отстранил его от компании |

Переходы:
- `pending` → `active` (принять) или `pending` → `rejected` (отклонить);
- `active` → `removed` (отстранить).

После `removed` агент может снова отправить заявку в ту же компанию: запись переводится обратно в `pending` (повторный запрос через тот же эндпоинт создания заявки).

---

## 3. Логика доступа к складам

### 3.1 Список компаний, к складам которых есть доступ

Используется функция **`_company_ids_for_warehouse_access(user)`** (в коде вьюх):

- компания владельца: `user.owned_company_id`;
- компания сотрудника: `user.company_id`;
- компании, где пользователь **активный агент**:  
  `CompanyWarehouseAgent.objects.filter(user=user, status='active').values_list('company_id', flat=True)`.

Итог: пользователь видит и может работать только со складами компаний из этого списка.

### 3.2 Контекст «текущей» компании

Для операций, где нужна одна компания (например, создание склада — только владелец/сотрудник), используется **`_company()`** в миксине:

- если есть `owned_company` или `company` — возвращается она;
- иначе, если есть привязка к филиалу — компания филиала;
- иначе для агента без своей компании — **первая** компания, где он активный агент.

Списки (склады, товары, заявки и т.д.) фильтруются по **всем** компаниям из `_company_ids_for_warehouse_access`, а не только по одной.

### 3.3 Заявки на товар (AgentRequestCart)

- Агент может создавать заявку только на склад той компании, к которой у него есть доступ (в т.ч. как активный агент).
- Проверка при создании заявки: `warehouse.company_id in _company_ids_for_warehouse_access(user)`.
- Логика одобрения/отклонения заявок на товар владельцем **не изменилась** — остаётся прежней.

---

## 4. API

Базовый префикс: **`/api/warehouse/`**.  
Аутентификация: **JWT** (`Authorization: Bearer <access_token>`).

---

### 4.1 Поиск компаний (для отправки заявки)

**`GET /api/warehouse/agents/companies/search/`**

Доступ: любой аутентифицированный пользователь (в т.ч. будущий агент).

**Query-параметры:**

| Параметр | Тип | Обязательный | Описание |
|----------|-----|--------------|----------|
| `search` | string | нет | Подстрока для поиска по названию компании (до 50 результатов) |

**Пример запроса:**
```http
GET /api/warehouse/agents/companies/search/?search=ООО
```

**Пример ответа (200):**
```json
[
  { "id": "uuid-1", "name": "ООО Ромашка", "slug": "ooo-romashka" },
  { "id": "uuid-2", "name": "ООО Зелень", "slug": "ooo-zelen" }
]
```

---

### 4.2 Список заявок в компанию / мои заявки

**`GET /api/warehouse/agents/company-requests/`**

- **Агент:** видит только **свои** заявки (по всем компаниям).
- **Владелец/админ:** видит заявки **в свою компанию** (все пользователи).

**Query-параметры:**

| Параметр | Тип | Обязательный | Описание |
|----------|-----|--------------|----------|
| `status` | string | нет | Фильтр: `pending`, `active`, `rejected`, `removed` |

**Пример запроса (агент):**
```http
GET /api/warehouse/agents/company-requests/
GET /api/warehouse/agents/company-requests/?status=pending
```

**Пример ответа (200):**
```json
[
  {
    "id": "uuid-request-1",
    "company": "uuid-company-1",
    "company_name": "ООО Ромашка",
    "user": "uuid-user-agent",
    "user_display": "Иван Иванов",
    "status": "active",
    "note": "Готов работать со складом",
    "created_at": "2025-02-18T10:00:00Z",
    "updated_at": "2025-02-18T12:00:00Z",
    "decided_at": "2025-02-18T12:00:00Z",
    "decided_by": "uuid-owner",
    "decided_by_display": "owner@company.com"
  }
]
```

---

### 4.3 Отправить заявку в компанию (стать агентом)

**`POST /api/warehouse/agents/company-requests/`**

Доступ: только **не** владелец/админ (обычно агент или обычный пользователь).

**Тело запроса (JSON):**

| Поле | Тип | Обязательное | Описание |
|------|-----|--------------|----------|
| `company` | UUID | да | ID компании (из поиска компаний) |
| `note` | string | нет | Краткое сообщение владельцу (до 512 символов) |

**Поведение:**

- Если заявки ещё не было: создаётся запись со статусом `pending`.
- Если уже есть запись:
  - `pending` — возвращается текущая запись (200), дубликат не создаётся.
  - `active` — ошибка 400: «Вы уже являетесь агентом этой компании».
  - `rejected` — ошибка 400: «Заявка была отклонена. Повторная заявка не предусмотрена».
  - `removed` — запись переводится обратно в `pending`, можно снова рассмотреть заявку.

**Пример запроса:**
```http
POST /api/warehouse/agents/company-requests/
Content-Type: application/json

{
  "company": "550e8400-e29b-41d4-a716-446655440000",
  "note": "Хочу работать агентом по вашему складу."
}
```

**Пример ответа (201):**
```json
{
  "id": "660e8400-e29b-41d4-a716-446655440001",
  "company": "550e8400-e29b-41d4-a716-446655440000",
  "company_name": "ООО Ромашка",
  "user": "uuid-current-user",
  "user_display": "Иван Иванов",
  "status": "pending",
  "note": "Хочу работать агентом по вашему складу.",
  "created_at": "2025-02-18T10:00:00Z",
  "updated_at": "2025-02-18T10:00:00Z",
  "decided_at": null,
  "decided_by": null,
  "decided_by_display": null
}
```

**Ошибки:**
- **400** — не указана компания: `{"company": ["Укажите компанию (id)."]}`.
- **400** — компания не найдена: `{"company": ["Компания не найдена."]}`.
- **400** — запрос от владельца/админа: `{"detail": "Владелец/админ не отправляет заявку в свою компанию."}`.

---

### 4.4 Принять заявку агента

**`POST /api/warehouse/agents/company-requests/{id}/accept/`**

Доступ: **владелец или администратор** той компании, в которую подана заявка.

Переводит статус заявки: `pending` → `active`. Агент получает доступ к складам компании.

**Пример запроса:**
```http
POST /api/warehouse/agents/company-requests/660e8400-e29b-41d4-a716-446655440001/accept/
```

**Пример ответа (200):** объект заявки с `"status": "active"`, заполнены `decided_at`, `decided_by`, `decided_by_display`.

**Ошибки:**
- **403** — не владелец/админ или нет компании у пользователя.
- **404** — заявка не найдена или не в статусе `pending` для этой компании.

---

### 4.5 Отклонить заявку агента

**`POST /api/warehouse/agents/company-requests/{id}/reject/`**

Доступ: **владелец или администратор** компании.

Переводит статус: `pending` → `rejected`. Повторная заявка от того же пользователя в ту же компанию через API не предусмотрена (остаётся `rejected`).

**Пример запроса:**
```http
POST /api/warehouse/agents/company-requests/660e8400-e29b-41d4-a716-446655440001/reject/
```

**Ответ (200):** объект заявки с `"status": "rejected"`.

---

### 4.6 Отстранить агента от компании

**`POST /api/warehouse/agents/company-requests/{id}/remove/`**

Доступ: **владелец или администратор** компании.

Переводит статус: `active` → `removed`. У агента забирается доступ к складам этой компании. Запись не удаляется; при необходимости агент может снова отправить заявку (запись переведётся в `pending` через `POST /api/warehouse/agents/company-requests/` с той же компанией).

**Пример запроса:**
```http
POST /api/warehouse/agents/company-requests/660e8400-e29b-41d4-a716-446655440001/remove/
```

**Ответ (200):** объект заявки с `"status": "removed"`.

**Ошибки:**
- **404** — запись не в статусе `active` для этой компании (например, уже отстранён или ещё не принят).

---

## 5. Сводка эндпоинтов

| Метод | URL | Кто вызывает | Назначение |
|-------|-----|--------------|------------|
| GET | `/api/warehouse/agents/companies/search/` | Любой авторизованный | Поиск компаний по названию |
| GET | `/api/warehouse/agents/company-requests/` | Агент / Владелец | Список заявок (свои / в свою компанию) |
| POST | `/api/warehouse/agents/company-requests/` | Агент | Отправить заявку в компанию |
| POST | `/api/warehouse/agents/company-requests/{id}/accept/` | Владелец/админ | Принять заявку |
| POST | `/api/warehouse/agents/company-requests/{id}/reject/` | Владелец/админ | Отклонить заявку |
| POST | `/api/warehouse/agents/company-requests/{id}/remove/` | Владелец/админ | Отстранить агента |

Имена маршрутов (Django):
- `warehouse-agents-companies-search`
- `warehouse-agents-company-requests`
- `warehouse-agents-company-request-accept`
- `warehouse-agents-company-request-reject`
- `warehouse-agents-company-request-remove`

---

## 6. Сценарии использования

### 6.1 Регистрация агента и начало работы со складом

Регистрация агента проходит **через отправку заявки в конкретную компанию** — отдельной формы «создать агента» нет, используется обычный пользовательский аккаунт.

1. Войти в систему под своим пользователем (без роли владельца/админа компании).
2. **Найти компанию, в которой хотите стать агентом:**  
   `GET /api/warehouse/agents/companies/search/?search=...` → выбрать нужную компанию по `id`.
3. **Отправить заявку на регистрацию как агента этой компании:**  
   `POST /api/warehouse/agents/company-requests/` с телом `{"company": "<uuid>", "note": "..."}`.
4. Дождаться решения владельца/админа компании:  
   - если заявка принята → статус `active`, вы становитесь агентом склада этой компании;  
   - если заявка отклонена → статус `rejected` (повторная заявка не отправляется);  
   - если позже владелец отстранил → статус `removed` (можно повторно подать заявку, см. раздел 4.3).
5. После того как заявка принята (статус `active`):
   - в списке складов `GET /api/warehouse/` появятся склады этой компании;
   - можно создавать заявки на товар: `POST /api/warehouse/agent-carts/` с выбранным `warehouse` этой компании;
   - можно работать с документами агента и остатками по существующим эндпоинтам (см. FRONTEND_API.md).

### 6.2 Владелец: приём, отклонение, отстранение

1. Войти под пользователем-владельцем или админом компании.
2. **Входящие заявки:**  
   `GET /api/warehouse/agents/company-requests/?status=pending` — список заявок в свою компанию.
3. **Принять:**  
   `POST /api/warehouse/agents/company-requests/{id}/accept/` — агент получает доступ к складам.
4. **Отклонить:**  
   `POST /api/warehouse/agents/company-requests/{id}/reject/`.
5. **Список текущих агентов:**  
   `GET /api/warehouse/agents/company-requests/?status=active`.
6. **Отстранить агента:**  
   `POST /api/warehouse/agents/company-requests/{id}/remove/` — доступ к складам компании снимается.

---

## 7. Связь с остальным модулем склада

- **Заявки на товар (agent-carts):** логика без изменений — агент создаёт заявку по складу, владелец одобряет/отклоняет. Изменено только то, что агент может выбирать склады **всех компаний, где он активный агент** (и при необходимости своей компании как сотрудник).
- **Документы агента, остатки, аналитика:** работают для пользователя, если у него есть доступ к компании склада (в т.ч. через `CompanyWarehouseAgent` со статусом `active`). Определение доступа — через `_company_ids_for_warehouse_access(user)` в вьюхах.
- **Контрагенты, касса, денежные документы:** подчиняются тем же правилам доступа по компании/филиалу; агент видит только данные тех компаний, к которым у него есть доступ.

---

## 8. Админка Django

Модель **CompanyWarehouseAgent** зарегистрирована в админке приложения `warehouse`:

- Список: пользователь, компания, статус, даты, кто решил.
- Фильтры: по статусу, по компании.
- Поиск: по email пользователя, названию компании, полю `note`.

При необходимости решения по заявкам можно выполнять и через админку (ручное изменение статуса).

---

## 9. Миграции

После добавления модели выполните:

```bash
python manage.py makemigrations warehouse --name company_warehouse_agent
python manage.py migrate
```

Имя миграции можно изменить при необходимости.
